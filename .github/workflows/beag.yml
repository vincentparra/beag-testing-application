name: BEAG

on:
  pull_request:
    branches: [ "master" ]

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Get changed files
        id: changed-files
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: $HEAD_SHA"

          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR "$BASE_SHA" "$HEAD_SHA" | paste -sd "," -)
          echo "Changed files (excluding deleted): $CHANGED_FILES"

          echo "CHANGED_FILES=$CHANGED_FILES" >> $GITHUB_ENV

      - name: Run BEAG on changed files only
        run: |
          echo "Running BEAG with changed files: $CHANGED_FILES"
          mvn beag:detect -DchangedFiles="$CHANGED_FILES"
